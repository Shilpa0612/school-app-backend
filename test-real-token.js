import dotenv from 'dotenv';
import admin from 'firebase-admin';

dotenv.config();

async function testRealToken() {
    console.log('üß™ Testing Real FCM Token');
    console.log('=========================');
    console.log('');

    try {
        // Initialize Firebase Admin SDK
        const serviceAccount = {
            type: "service_account",
            project_id: process.env.FIREBASE_PROJECT_ID,
            private_key_id: process.env.FIREBASE_PRIVATE_KEY_ID,
            private_key: process.env.FIREBASE_PRIVATE_KEY?.replace(/\\n/g, '\n'),
            client_email: process.env.FIREBASE_CLIENT_EMAIL,
            client_id: process.env.FIREBASE_CLIENT_ID,
            auth_uri: "https://accounts.google.com/o/oauth2/auth",
            token_uri: "https://oauth2.googleapis.com/token",
            auth_provider_x509_cert_url: "https://www.googleapis.com/oauth2/v1/certs",
            client_x509_cert_url: process.env.FIREBASE_CLIENT_CERT_URL
        };

        if (!admin.apps.length) {
            admin.initializeApp({
                credential: admin.credential.cert(serviceAccount),
                projectId: process.env.FIREBASE_PROJECT_ID
            });
        }

        console.log('Backend Firebase Project ID:', process.env.FIREBASE_PROJECT_ID);
        console.log('Backend Client Email:', process.env.FIREBASE_CLIENT_EMAIL);
        console.log('');

        // Test with the real token from your database
        const realToken = 'eAPuK3JJSSG4JP_G-7ri9D:APA91bE_aFHFvtyLYWkApzN_sou0dsXVcut7rJRYPi2Yj1wPevDZ3jT5do3M_FAO_InNLDmYnjbdVgG0ed1jjtgHXu1HbwiR7STCjsONZo7LzkyTkYZgic';

        console.log('Testing with real token:');
        console.log(`Token: ${realToken.substring(0, 50)}...`);
        console.log('');

        try {
            const message = {
                token: realToken,
                notification: {
                    title: 'Test',
                    body: 'Testing real token'
                }
            };

            const response = await admin.messaging().send(message);
            console.log('‚úÖ SUCCESS! Token is valid for this project');
            console.log('Message ID:', response);

        } catch (error) {
            console.log('‚ùå ERROR with real token:');
            console.log('Error code:', error.code);
            console.log('Error message:', error.message);

            if (error.code === 'messaging/mismatched-credential') {
                console.log('');
                console.log('üö® SENDERID MISMATCH CONFIRMED');
                console.log('This token was generated by a DIFFERENT Firebase project');
                console.log('than your backend configuration.');
                console.log('');
                console.log('üîß SOLUTION:');
                console.log('1. The token was generated by a different Firebase project');
                console.log('2. You need to either:');
                console.log('   a) Use the correct Firebase project for this token, OR');
                console.log('   b) Generate a new token from your current project');
                console.log('3. If you have a mobile app, ensure it uses the same');
                console.log('   google-services.json as your backend project');
            }
        }

    } catch (error) {
        console.log('‚ùå Setup error:', error.message);
    }
}

testRealToken();
